# Sample workflow for building and deploying a Hugo site to GitHub Pages
name: Build Openwrt official

on:
  workflow_dispatch:
    inputs:
      target:
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - r4s
          - r2s

# Default to bash
defaults:
  run:
    shell: bash

env:
  OPENWRT_TAG: v22.03.5
  OPENWRT_FEED_BRANCH: openwrt-22.03
  
jobs:
  # Build job
  build:
    runs-on: self-hosted
    steps:
      - name: test env
        run: |
          env
          pwd 
          ls -al
          ls -al /data
      # - name: update feeds
      #   working-directory: openwrt
      #   run: |
      #     ./scripts/feeds update -a && ./scripts/feeds install -a && ./feeds/plugin/sync.sh
      #     mv feeds/plugin/${{ inputs.target }}.config .config

      # - name: generate .config
      #   working-directory: openwrt
      #   run: make defconfig

      # - name: download package
      #   working-directory: openwrt
      #   run: make download -j16

      # - name: compile firmware
      #   working-directory: openwrt
      #   run: |
      #     echo -e "$(nproc) thread compile"
      #     make -j$(nproc) || make -j1 || make -j1 V=s
      #     echo "::set-output name=status::success"

      # - name: check space usage
      #   working-directory: openwrt
      #   run: |
      #     df -h
      #     echo "======================="
      #     du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
      #     du -h --max-depth=1 ./build_dir
      #     du -h --max-depth=1 ./bin

      # - name: Prepare artifact
      #   working-directory: openwrt
      #   run: |
      #     mkdir -p ./artifact/package
      #     mkdir -p ./artifact/buildinfo
      #     rm -rf $(find ./bin/targets/ -type d -name "packages")
      #     cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
      #     cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

      # - name: Upload buildinfo
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: OpenWrt_buildinfo
      #     path: ./artifact/buildinfo/

      # - name: Upload package
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: OpenWrt_package
          
          
