# Sample workflow for building and deploying a Hugo site to GitHub Pages
name: Build Openwrt official

on:
  workflow_dispatch:
    inputs:
      target:
        required: true
        default: 'x86-64'
        type: choice
        options:
          - x86-64
          - r4s
          - r2s
      first_build:
        required: true
        default: false
        type: boolean

defaults:
  run:
    shell: bash
  
jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: init
        working-directory: /data/openwrt
        run: |
          echo "openwrt_version=$(git describe | sed 's|v||')" >> "$GITHUB_ENV"
          echo "first_build=${{ inputs.first_build }}" >> "$GITHUB_ENV"

      - name: update
        working-directory: /data/openwrt
        run: ./scripts/feeds update -a && ./scripts/feeds install -a && ./feeds/plugin/sync.sh

      - name: config
        working-directory: /data/openwrt
        run: |
          cp feeds/plugin/${{ inputs.target }}.config .config
          if [ "${first_build}" == "true" ];then
            grep 'CONFIG_TARGET' > .config
          fi
          rm -rf tmp && make defconfig

      - name: download
        working-directory: /data/openwrt
        run: make download -j8

      - name: compile
        working-directory: /data/openwrt
        run: |
          if [ "${first_build}" == "true" ];then
            make -j1 || make -j1 V=s > compile.log
          else
            echo -e "$(nproc) thread compile"
            make -j$(nproc) > compile.log || make -j1 V=s > compile.log
          fi
          echo "::set-output name=status::success"
          
      # - name: Prepare artifact
      #   working-directory: openwrt
      #   run: |
      #     mkdir -p ./artifact/package
      #     mkdir -p ./artifact/buildinfo
      #     rm -rf $(find ./bin/targets/ -type d -name "packages")
      #     cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
      #     cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

      # - name: Upload buildinfo
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: OpenWrt_buildinfo
      #     path: ./artifact/buildinfo/

      # - name: Upload package
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: OpenWrt_package
          
          
