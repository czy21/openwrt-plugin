# Sample workflow for building and deploying a Hugo site to GitHub Pages
name: Build Openwrt official

on:
  workflow_dispatch:
    inputs:
      target:
        required: true
        default: 'x86-64'
        type: choice
        options:
          - x86-64
          - r4s
          - r2s

defaults:
  run:
    shell: bash
  
jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: init env
        working-directory: /data/openwrt
        run: |
          echo "openwrt_version=$(git describe | sed 's|v||')" >> "$GITHUB_ENV"

      - name: update feeds
        working-directory: /data/openwrt
        run: |
          ./scripts/feeds update -a && ./scripts/feeds install -a && ./feeds/plugin/sync.sh
          echo ${{ env.openwrt_version }}

      - name: use target .config
        working-directory: /data/openwrt
        run: |
          cp feeds/plugin/${{ inputs.target }}.config .config
          rm -rf tmp && make defconfig

      - name: compile firmware
        working-directory: /data/openwrt
        run: |
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s
          echo "::set-output name=status::success"
          
      # - name: Prepare artifact
      #   working-directory: openwrt
      #   run: |
      #     mkdir -p ./artifact/package
      #     mkdir -p ./artifact/buildinfo
      #     rm -rf $(find ./bin/targets/ -type d -name "packages")
      #     cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
      #     cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

      # - name: Upload buildinfo
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: OpenWrt_buildinfo
      #     path: ./artifact/buildinfo/

      # - name: Upload package
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: OpenWrt_package
          
          
