name: Build images

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      subtarget:
        required: true
        type: string
      openwrt_tag:
        type: string
      openwrt_branch:
        type: string
      artifact_dir: 
        required: false
        type: string
        default: /volume2/storage/docker-data/ubuntu-openwrt/data/download

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Build ${{ inputs.target }}/${{ inputs.subtarget }}
    runs-on: self-hosted
    container:
      image: openwrt/imagebuilder:${{ inputs.target }}-${{ inputs.subtarget }}-${{ inputs.openwrt_branch }}
      volumes:
        - ${{ inputs.target }}-${{ inputs.subtarget }}-${{ inputs.openwrt_branch }}:/builder
        - ${{ inputs.artifact_dir }}/arch-targets/:/builder/bin/targets/
      options: --user root --privileged --pull always --rm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init
        shell: su buildbot -c "bash {0}"
        working-directory: /builder
        run: |
          id;pwd;ls -al;ls -alR bin
          sed -i -e 's|https://downloads.openwrt.org|http://openwrt-firmware.czy21-internal.com/download|' -e 's|releases.*-SNAPSHOT|releases/${{ inputs.openwrt_tag }}|' repositories.conf
          cat repositories.conf

      - name: Generate
        shell: su buildbot -c "bash {0}"
        working-directory: /builder
        run: |
          ls -al