name: Build packages

on:
  workflow_call:
    inputs:
      arch:
        required: true
        type: string
      openwrt_branch:
        type: string

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Build ${{ inputs.arch }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine changed packages
        run: |
          # fallback to test packages if nothing explicitly changes this is
          # should run if other mechanics in packages.git changed
          PACKAGES="${PACKAGES:-luci-app-attendedsysupgrade}"

          echo "Building $PACKAGES"
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

      - name: Build
        uses: openwrt/gh-action-sdk@v7
        env:
          ARCH: ${{ inputs.arch }}-${{ inputs.openwrt_branch }}
          FEEDNAME: packages_ci
          V: s

#      - name: Move created packages to project dir
#        if: always()
#        run: cp bin/packages/${{ inputs.arch }}/packages_ci/* . || true

      - name: Store packages
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.arch }}-packages
          path: "cp bin/packages/${{ inputs.arch }}/packages_ci/"

      - name: Store logs
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.arch }}-logs
          path: "logs/"